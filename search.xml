<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>git开发流程简述</title>
    <url>/2020/07/06/git%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B%E7%AE%80%E8%BF%B0/</url>
    <content><![CDATA[<h3 id="功能分支开发流简述"><a href="#功能分支开发流简述" class="headerlink" title="功能分支开发流简述"></a>功能分支开发流简述</h3><p>功能分支工作流是一种被证明的高效的多人合作开发模式，其核心思想是所有的功能开发都应该有一个专门的分支，而不是在主干分支上。这样的隔离模式可以方便多个开发者在各自的功能分支上开发而不会弄乱主干代码。另外也保证了主干分支的代码一定是没有问题可随时上线的，极大的有利于在集成环境中合作开发。</p>
<p>功能分支工作流也让code review 变得很方便，每个开发者在将自己的功能分支合并到主干分支（或迭代分支）时发起code review流程，由其他开发者审阅和讨论，这将有助于提升团队的代码质量。</p>
<p>功能分支工作流的总流程如下图所示：</p>
<span id="more"></span>

<img src="/images/git_flow.png" class="" title="git分支工作流">



<h3 id="一个日常示例"><a href="#一个日常示例" class="headerlink" title="一个日常示例"></a>一个日常示例</h3><p><strong>拉取迭代分支</strong></p>
<p>PM周五召集RD们开需求会，确定下一阶段迭代需求的开发工作，会后开发负责人从master拉取了一个迭代分支</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[work@dev web] (master) $ git pull</span><br><span class="line">Already up to date.</span><br><span class="line">[work@dev web] (master) $ git checkout -b iterative_20200706</span><br><span class="line">Switched to a new branch <span class="string">&#x27;iterative_20200706&#x27;</span></span><br><span class="line">[work@dev web] (iterative_20200706) $ git push -u origin iterative_20200706</span><br><span class="line">Branch <span class="string">&#x27;iterative_20200706&#x27;</span> <span class="built_in">set</span> up to track remote branch <span class="string">&#x27;iterative_20200706&#x27;</span> from <span class="string">&#x27;origin&#x27;</span>.</span><br></pre></td></tr></table></figure>



<p><strong>拉取功能分支</strong></p>
<p>RD们内部沟通并分解完任务后，分别从迭代分支拉取了各自的开发分支，并进入肝代码的节奏中</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 张三负责开发”工单系统“</span></span><br><span class="line">[zhang3@dev web] (iterative_20200706) $ git pull</span><br><span class="line">Already up to date.</span><br><span class="line">[zhang3@dev web] (iterative_20200706) $ git checkout -b zhang3_issue</span><br><span class="line">Switched to a new branch <span class="string">&#x27;zhang3_issue&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 李四负责开发”导出系统“</span></span><br><span class="line">[li4@dev web] (iterative_20200706) $ git pull</span><br><span class="line">Already up to date.</span><br><span class="line">[li4@dev web] (iterative_20200706) $ git checkout -b li4_export</span><br><span class="line">Switched to a new branch <span class="string">&#x27;li4_export&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 王五负责开发”安全洞察“</span></span><br><span class="line">[wang5@dev web] (iterative_20200706) $ git pull</span><br><span class="line">Already up to date.</span><br><span class="line">[wang5@dev web] (iterative_20200706) $ git checkout -b wang5_insight</span><br><span class="line">Switched to a new branch <span class="string">&#x27;wang5_insight&#x27;</span></span><br></pre></td></tr></table></figure>



<p><strong>提交功能分支代码</strong></p>
<p>周四晚上，工程师李四率先完成了自己的开发工作并自测完毕，决定提交Merge Request并发起code review流程，由具有代码合并权限的开发负责人审查后合并，然后向QA提测</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看修改的文件</span></span><br><span class="line">[li4@dev web] (li4_export) $ git status -s</span><br><span class="line"> M web/config.py</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 添加到暂存区</span></span><br><span class="line">[li4@dev web] (li4_export) $ git add .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交commit</span></span><br><span class="line">[li4@dev web] (li4_export) $ git commit -m <span class="string">&#x27;李四关于导出系统的修改&#x27;</span></span><br><span class="line">1 file changed, 5 insertions(+), 5 deletions(-)</span><br><span class="line"></span><br><span class="line"><span class="comment"># rebase </span></span><br><span class="line">[li4@dev web] (li4_export) $ git pull --rebase origin iterative_20200706</span><br><span class="line"> * branch            iterative_20200706 -&gt; FETCH_HEAD</span><br><span class="line">Current branch li4_export is up to date.</span><br><span class="line"></span><br><span class="line"><span class="comment"># push</span></span><br><span class="line">[li4@dev web] (li4_export) $ git push -u origin li4_export</span><br><span class="line"> * [new branch]      li4_export -&gt; li4_export</span><br><span class="line">Branch <span class="string">&#x27;li4_export&#x27;</span> <span class="built_in">set</span> up to track remote branch <span class="string">&#x27;li4_export&#x27;</span> from <span class="string">&#x27;origin&#x27;</span>.</span><br></pre></td></tr></table></figure>

<p>李四做完以上操作后，去gitlab上发起Merge Request开始code review流程，如图所示：</p>
<img src="/images/git_mr.png" class="" title="git提交mr">



<p>开发负责人需要履行自己审核代码的职责，认真阅读代码并且无异议后，将李四的代码合并到迭代分支。</p>
<p><strong>提交功能分支代码</strong></p>
<p>待其他工程师陆续完成自己的开发工作，各自创建了自己的code review流程并合并代码，并且QA也测试验收通过，确定达到上线标准。负责人需要将迭代分支合并到master上，完成本轮迭代开发。</p>
<h3 id="线上紧急BUG处理"><a href="#线上紧急BUG处理" class="headerlink" title="线上紧急BUG处理"></a>线上紧急BUG处理</h3><p>当发现线上出现故障或BUG，需要紧急处理时，直接从master拉取分支进行修复，流程如下图的红色部分：</p>
<img src="/images/git_flow_fix.png" class="" title="git fix bug">

<p>在日常开发中，如果发现线上bug或是后期待优化的点，建议提交issue：</p>
<img src="/images/git_issue.png" class="" title="git issue">

<p>issue建立后，基于issue创建对应的处理分支，后续在该分支上进行修复或开发</p>
<img src="/images/git_issue_br.png" class="" title="git issue branch">



<h3 id="精简版分支开发流程"><a href="#精简版分支开发流程" class="headerlink" title="精简版分支开发流程"></a>精简版分支开发流程</h3><p>在日常开发工作中，由于需求内容相对简单独立，并没有使用迭代开发的流程，这类项目适用于精简版的分支开发流程，如下图所示：</p>
<img src="/images/git_flow_mini.png" class="" title="git flow mini">


<h3 id="分支管理规范"><a href="#分支管理规范" class="headerlink" title="分支管理规范"></a>分支管理规范</h3><ol>
<li><p>迭代分支命名规范</p>
<p>迭代分支命名格式为”iteration_描述“，其中描述可以是迭代开始的日期，如”iteration_20200706”，也可以是功能描述，如”iteration_export”， 还可以是版本号，如”iteration_v1“。</p>
</li>
<li><p>功能分支命名规范</p>
<p>功能分支命名格式为”开发者_功能描述”，其中开发者信息不可缺失，如李四建立的开发分支为”lisi_export”，严禁分支取名为无意义的名字。</p>
</li>
<li><p>紧急上线分支命名规范</p>
<p>线上BUG紧急修复的分支命名格式为”开发_功能描述_hotfix“，hotfix后缀用来表示紧急修复。</p>
</li>
<li><p>Code Review规范</p>
<p>合并代码前，必须走code review流程，严禁自己合并自己的代码，同时代码合并者必须起到review的作用，并且承担20%的故障责任。</p>
</li>
</ol>
]]></content>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>DRF最佳实践及源码解读(一)--简介</title>
    <url>/2020/04/18/DRF%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E4%B8%80-%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<img src="/images/djangorestframework.png" class="" title="DRF框架">

<p>Django REST framework 框架是一个用于构建REST API 的强大而又灵活的工具，DRF框架建立在Django框架基础之上。</p>
<span id="more"></span>

<p><strong>DRF特点:</strong></p>
<ul>
<li>提供了定义序列化器Serializer的方法，可以快速根据 Django ORM 或者其它库自动序列化/反序列化</li>
<li>提供了丰富的类视图、Mixin扩展类，简化了视图的编写</li>
<li>丰富的定制层级：函数视图、类视图、视图集合到自动生成 API，满足各种需要</li>
<li>支持多种身份认证和权限认证方式</li>
<li>内置灵活的限流系统</li>
<li>直观的 API web 界面</li>
<li>具有丰富的插件和强大扩展性</li>
</ul>
]]></content>
      <categories>
        <category>Python</category>
        <category>Web</category>
      </categories>
      <tags>
        <tag>Django</tag>
        <tag>Python</tag>
        <tag>Restful</tag>
      </tags>
  </entry>
  <entry>
    <title>DRF最佳实践及源码解读(七)--权限</title>
    <url>/2020/04/19/DRF%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E4%B8%83-%E6%9D%83%E9%99%90/</url>
    <content><![CDATA[<img src="/images/djangorestframework.png" class="" title="DRF框架">

<span id="more"></span>

<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">1.自定义认证类，继承rest_framework.permissions.BasePermission, 实现has_permission方法</span></span><br><span class="line"><span class="string">2.视图类局部配置或全局配置</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> BasePermission</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPermission</span>(<span class="params">BasePermission</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_permission</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="keyword">if</span> request.user.user_type != <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span>    <span class="comment"># 无权访问</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span>     <span class="comment"># 有权访问</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># 局部配置</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 视图类中局部配置</span></span><br><span class="line">    permission_classes = [MyPermission,]</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PERMISSION_CLASSES&#x27;</span>: [<span class="string">&#x27;api.permissions.MyPermission&#x27;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_permissions</span>(<span class="params">self, request</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Check if the request should be permitted.</span></span><br><span class="line"><span class="string">    Raises an appropriate exception if the request is not permitted.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> permission <span class="keyword">in</span> self.get_permissions():</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> permission.has_permission(request, self):</span><br><span class="line">            self.permission_denied(</span><br><span class="line">                request, message=<span class="built_in">getattr</span>(permission, <span class="string">&#x27;message&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Python</category>
        <category>Web</category>
      </categories>
      <tags>
        <tag>Django</tag>
        <tag>Python</tag>
        <tag>Restful</tag>
      </tags>
  </entry>
  <entry>
    <title>DRF最佳实践及源码解读(三)--路由</title>
    <url>/2020/04/18/DRF%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E4%B8%89-%E8%B7%AF%E7%94%B1/</url>
    <content><![CDATA[<img src="/images/djangorestframework.png" class="" title="DRF框架">

<span id="more"></span>

<h2 id="Django原始路由配置"><a href="#Django原始路由配置" class="headerlink" title="Django原始路由配置"></a>Django原始路由配置</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^(?P&lt;version&gt;v[12])/view/$&#x27;</span>, views.MyView.as_view()),</span><br><span class="line">    url(<span class="string">r&#x27;^(?P&lt;version&gt;v[12])/view2/$&#x27;</span>, views.MyViewSet.as_view(&#123;<span class="string">&#x27;get&#x27;</span>: <span class="string">&#x27;list&#x27;</span>, <span class="string">&#x27;post&#x27;</span>: <span class="string">&#x27;create&#x27;</span>&#125;)),</span><br><span class="line">    url(<span class="string">r&#x27;^(?P&lt;version&gt;v[12])/view2/(?P&lt;pk&gt;\d+)/$&#x27;</span>, views.MyViewSet.as_view(&#123;<span class="string">&#x27;get&#x27;</span>: <span class="string">&#x27;retrieve&#x27;</span>&#125;)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="DRF视图集自动路由"><a href="#DRF视图集自动路由" class="headerlink" title="DRF视图集自动路由"></a>DRF视图集自动路由</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">router = routers.DefaultRouter()</span><br><span class="line">router.register(<span class="string">&#x27;users&#x27;</span>, UserViewSet, <span class="string">&#x27;user&#x27;</span>)</span><br><span class="line">router.register(<span class="string">&#x27;accounts&#x27;</span>, AccountViewSet, <span class="string">&#x27;account&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册方式一</span></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    ...,</span><br><span class="line">    url(<span class="string">r&#x27;^(?P&lt;version&gt;v[12])/&#x27;</span>, include(router.urls)),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册方式二</span></span><br><span class="line"></span><br><span class="line">urlpatterns += router.urls</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Python</category>
        <category>Web</category>
      </categories>
      <tags>
        <tag>Django</tag>
        <tag>Python</tag>
        <tag>Restful</tag>
      </tags>
  </entry>
  <entry>
    <title>DRF最佳实践及源码解读(二)--视图</title>
    <url>/2020/04/18/DRF%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E4%BA%8C-%E8%A7%86%E5%9B%BE/</url>
    <content><![CDATA[<img src="/images/djangorestframework.png" class="" title="DRF框架">

<h2 id="DRF视图类最佳实践"><a href="#DRF视图类最佳实践" class="headerlink" title="DRF视图类最佳实践"></a>DRF视图类最佳实践</h2><p>简单增删改查：<code>ModelViewSet</code></p>
<p>增删：<code>CreateModelMixin</code> + <code>DestroyModelMixin</code> + <code>GenericViewSet</code></p>
<p>复杂逻辑：<code>GenericViewSet</code> 或 <code>APIView</code> (多个路由的相同请求方法使用同一个视图类的时候，使用<code>GenericViewSet</code>)</p>
<span id="more"></span>



<h3 id="视图类继承关系"><a href="#视图类继承关系" class="headerlink" title="视图类继承关系"></a>视图类继承关系</h3><img src="/images/drf_view_class.png" class="" title="DRF视图类继承关系">


<h3 id="视图类源码解读"><a href="#视图类源码解读" class="headerlink" title="视图类源码解读"></a>视图类源码解读</h3><h4 id="django-views-generic-View"><a href="#django-views-generic-View" class="headerlink" title="django.views.generic.View"></a>django.views.generic.View</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># django原生CBV</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> View</span><br><span class="line"><span class="comment"># 对视图函数的装饰需要使用method_decorator</span></span><br><span class="line"><span class="keyword">from</span> django.utils.decorators <span class="keyword">import</span> method_decorator</span><br><span class="line"></span><br><span class="line"><span class="meta">@method_decorator(<span class="params">uc_login_required(<span class="params"></span>), name=<span class="string">&#x27;dispatch&#x27;</span></span>)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CheckERPView</span>(<span class="params">View</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    django原生CVB使用示例</span></span><br><span class="line"><span class="string">    通过viewClass.as_view()返回包装后的视图函数，同时以闭包的方式将视图类封装进视图函数</span></span><br><span class="line"><span class="string">    在View.dispatch()中通过对请求方法的判断将请求分发到具体的get/post/put/delete方法中</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request, *args, **kwargs</span>)):</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>




<h4 id="rest-framework-views-APIView"><a href="#rest-framework-views-APIView" class="headerlink" title="rest_framework.views.APIView"></a>rest_framework.views.APIView</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">DRF基础视图类</span></span><br><span class="line"><span class="string">APIView是DRF提供的所有视图的基类继承自Django的View</span></span><br><span class="line"><span class="string">APIVIew通过对dispatch方法的增强，主要实现了以下功能:</span></span><br><span class="line"><span class="string">    1.initialize_request()对django的request进行封装，得到DRF的request</span></span><br><span class="line"><span class="string">    2.视图方法可以返回DRF的Response</span></span><br><span class="line"><span class="string">    3.任何APIException异常都会被捕获到，并且处理成合适的响应信息</span></span><br><span class="line"><span class="string">    4.在dispatch()分发前，会对请求进行身份认证、权限检查、流量控制，相应的扩展通过类属性进行配置，可以在类中局部配置，也可以在配置文件中全局配置</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIView</span>(<span class="params">View</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># The following policies may be set at either globally, or per-view.</span></span><br><span class="line">    renderer_classes = api_settings.DEFAULT_RENDERER_CLASSES</span><br><span class="line">    parser_classes = api_settings.DEFAULT_PARSER_CLASSES</span><br><span class="line">    authentication_classes = api_settings.DEFAULT_AUTHENTICATION_CLASSES</span><br><span class="line">    throttle_classes = api_settings.DEFAULT_THROTTLE_CLASSES</span><br><span class="line">    permission_classes = api_settings.DEFAULT_PERMISSION_CLASSES</span><br><span class="line">    content_negotiation_class = api_settings.DEFAULT_CONTENT_NEGOTIATION_CLASS</span><br><span class="line">    metadata_class = api_settings.DEFAULT_METADATA_CLASS</span><br><span class="line">    versioning_class = api_settings.DEFAULT_VERSIONING_CLASS</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Allow dependency injection of other settings to make testing easier.</span></span><br><span class="line">    settings = api_settings</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Mark the view as being included or excluded from schema generation.</span></span><br><span class="line">    exclude_from_schema = <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Note: Views are made CSRF exempt from within `as_view` as to prevent</span></span><br><span class="line">    <span class="comment"># accidental removal of this exemption in cases where `dispatch` needs to</span></span><br><span class="line">    <span class="comment"># be overridden.</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        `.dispatch()` is pretty much the same as Django&#x27;s regular dispatch,</span></span><br><span class="line"><span class="string">        but with extra hooks for startup, finalize, and exception handling.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.args = args</span><br><span class="line">        self.kwargs = kwargs</span><br><span class="line">        request = self.initialize_request(request, *args, **kwargs)</span><br><span class="line">        self.request = request</span><br><span class="line">        self.headers = self.default_response_headers  <span class="comment"># deprecate?</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.initial(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Get the appropriate handler method</span></span><br><span class="line">            <span class="keyword">if</span> request.method.lower() <span class="keyword">in</span> self.http_method_names:</span><br><span class="line">                handler = <span class="built_in">getattr</span>(self, request.method.lower(),</span><br><span class="line">                                  self.http_method_not_allowed)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                handler = self.http_method_not_allowed</span><br><span class="line"></span><br><span class="line">            response = handler(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">            response = self.handle_exception(exc)</span><br><span class="line"></span><br><span class="line">        self.response = self.finalize_response(request, response, *args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> self.response</span><br><span class="line">    </span><br></pre></td></tr></table></figure>


<h4 id="rest-framework-generics-GenericAPIView"><a href="#rest-framework-generics-GenericAPIView" class="headerlink" title="rest_framework.generics.GenericAPIView"></a>rest_framework.generics.GenericAPIView</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">PS:通常不直接使用</span></span><br><span class="line"><span class="string">GenericAPIView继承自APIView</span></span><br><span class="line"><span class="string">增加了对列表视图和详情视图的通用处理方法</span></span><br><span class="line"><span class="string">    1.通过queryset配置查询集</span></span><br><span class="line"><span class="string">    2.通过serializer_class配置序列化器</span></span><br><span class="line"><span class="string">    3.通过pagination_class配置分页器</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericAPIView</span>(<span class="params">views.APIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Base class for all other generic views.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># You&#x27;ll need to either set these attributes,</span></span><br><span class="line">    <span class="comment"># or override `get_queryset()`/`get_serializer_class()`.</span></span><br><span class="line">    <span class="comment"># If you are overriding a view method, it is important that you call</span></span><br><span class="line">    <span class="comment"># `get_queryset()` instead of accessing the `queryset` property directly,</span></span><br><span class="line">    <span class="comment"># as `queryset` will get evaluated only once, and those results are cached</span></span><br><span class="line">    <span class="comment"># for all subsequent requests.</span></span><br><span class="line">    queryset = <span class="literal">None</span></span><br><span class="line">    serializer_class = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># If you want to use object lookups other than pk, set &#x27;lookup_field&#x27;.</span></span><br><span class="line">    <span class="comment"># For more complex lookup requirements override `get_object()`.</span></span><br><span class="line">    lookup_field = <span class="string">&#x27;pk&#x27;</span></span><br><span class="line">    lookup_url_kwarg = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># The filter backend classes to use for queryset filtering</span></span><br><span class="line">    filter_backends = api_settings.DEFAULT_FILTER_BACKENDS</span><br><span class="line"></span><br><span class="line">    <span class="comment"># The style to use for queryset pagination.</span></span><br><span class="line">    pagination_class = api_settings.DEFAULT_PAGINATION_CLASS</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        queryset = self.queryset</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(queryset, QuerySet):</span><br><span class="line">            <span class="comment"># Ensure queryset is re-evaluated on each request.</span></span><br><span class="line">            queryset = queryset.<span class="built_in">all</span>()</span><br><span class="line">        <span class="keyword">return</span> queryset</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_object</span>(<span class="params">self</span>):</span></span><br><span class="line">        filter_kwargs = &#123;self.lookup_field: self.kwargs[lookup_url_kwarg]&#125;</span><br><span class="line">        obj = get_object_or_404(queryset, **filter_kwargs)</span><br><span class="line">        <span class="comment"># May raise a permission denied</span></span><br><span class="line">        self.check_object_permissions(self.request, obj)</span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        serializer_class = self.get_serializer_class()</span><br><span class="line">        kwargs[<span class="string">&#x27;context&#x27;</span>] = self.get_serializer_context()</span><br><span class="line">        <span class="keyword">return</span> serializer_class(*args, **kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.serializer_class</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_context</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            <span class="string">&#x27;request&#x27;</span>: self.request,</span><br><span class="line">            <span class="string">&#x27;format&#x27;</span>: self.format_kwarg,</span><br><span class="line">            <span class="string">&#x27;view&#x27;</span>: self</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">filter_queryset</span>(<span class="params">self, queryset</span>):</span></span><br><span class="line">        <span class="keyword">for</span> backend <span class="keyword">in</span> <span class="built_in">list</span>(self.filter_backends):</span><br><span class="line">            queryset = backend().filter_queryset(self.request, queryset, self)</span><br><span class="line">        <span class="keyword">return</span> queryset</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">paginator</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(self, <span class="string">&#x27;_paginator&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> self.pagination_class <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                self._paginator = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self._paginator = self.pagination_class()</span><br><span class="line">        <span class="keyword">return</span> self._paginator</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">paginate_queryset</span>(<span class="params">self, queryset</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.paginator <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> self.paginator.paginate_queryset(queryset, self.request, view=self)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_paginated_response</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="keyword">assert</span> self.paginator <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> self.paginator.get_paginated_response(data)</span><br></pre></td></tr></table></figure>


<h4 id="rest-framework-viewsets-GenericViewSet"><a href="#rest-framework-viewsets-GenericViewSet" class="headerlink" title="rest_framework.viewsets.GenericViewSet"></a>rest_framework.viewsets.GenericViewSet</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">继承自ViewSetMixin和GenericAPIView</span></span><br><span class="line"><span class="string">基于ViewSetMixin对as_view()方法进行升级，实现了请求方法与方法名的自定义绑定</span></span><br><span class="line"><span class="string">配置路由的时候传入请求方法与分发方法的对应关系：</span></span><br><span class="line"><span class="string">    MyViewSet.as_view(&#123;&#x27;get&#x27;: &#x27;list&#x27;, &#x27;post&#x27;: &#x27;create&#x27;&#125;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericViewSet</span>(<span class="params">ViewSetMixin, generics.GenericAPIView</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    The GenericViewSet class does not provide any actions by default,</span></span><br><span class="line"><span class="string">    but does include the base set of generic view behavior, such as</span></span><br><span class="line"><span class="string">    the `get_object` and `get_queryset` methods.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewSetMixin</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    This is the magic.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Overrides `.as_view()` so that it takes an `actions` keyword that performs</span></span><br><span class="line"><span class="string">    the binding of HTTP methods to actions on the Resource.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    For example, to create a concrete view binding the &#x27;GET&#x27; and &#x27;POST&#x27; methods</span></span><br><span class="line"><span class="string">    to the &#x27;list&#x27; and &#x27;create&#x27; actions...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    view = MyViewSet.as_view(&#123;&#x27;get&#x27;: &#x27;list&#x27;, &#x27;post&#x27;: &#x27;create&#x27;&#125;)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @classonlymethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">as_view</span>(<span class="params">cls, actions=<span class="literal">None</span>, **initkwargs</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Because of the way class based views create a closure around the</span></span><br><span class="line"><span class="string">        instantiated view, we need to totally reimplement `.as_view`,</span></span><br><span class="line"><span class="string">        and slightly modify the view function that is created and returned.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">view</span>(<span class="params">request, *args, **kwargs</span>):</span></span><br><span class="line">            self = cls(**initkwargs)</span><br><span class="line">            <span class="comment"># We also store the mapping of request methods to actions,</span></span><br><span class="line">            <span class="comment"># so that we can later set the action attribute.</span></span><br><span class="line">            <span class="comment"># eg. `self.action = &#x27;list&#x27;` on an incoming GET request.</span></span><br><span class="line">            self.action_map = actions</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Bind methods to actions</span></span><br><span class="line">            <span class="comment"># This is the bit that&#x27;s different to a standard view</span></span><br><span class="line">            <span class="keyword">for</span> method, action <span class="keyword">in</span> actions.items():</span><br><span class="line">                handler = <span class="built_in">getattr</span>(self, action)</span><br><span class="line">                <span class="built_in">setattr</span>(self, method, handler)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(self, <span class="string">&#x27;get&#x27;</span>) <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">hasattr</span>(self, <span class="string">&#x27;head&#x27;</span>):</span><br><span class="line">                self.head = self.get</span><br><span class="line"></span><br><span class="line">            self.request = request</span><br><span class="line">            self.args = args</span><br><span class="line">            self.kwargs = kwargs</span><br><span class="line"></span><br><span class="line">            <span class="comment"># And continue as usual</span></span><br><span class="line">            <span class="keyword">return</span> self.dispatch(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># take name and docstring from class</span></span><br><span class="line">        update_wrapper(view, cls, updated=())</span><br><span class="line"></span><br><span class="line">        <span class="comment"># and possible attributes set by decorators</span></span><br><span class="line">        <span class="comment"># like csrf_exempt from dispatch</span></span><br><span class="line">        update_wrapper(view, cls.dispatch, assigned=())</span><br><span class="line"></span><br><span class="line">        <span class="comment"># We need to set these on the view function, so that breadcrumb</span></span><br><span class="line">        <span class="comment"># generation can pick out these bits of information from a</span></span><br><span class="line">        <span class="comment"># resolved URL.</span></span><br><span class="line">        view.cls = cls</span><br><span class="line">        view.initkwargs = initkwargs</span><br><span class="line">        view.suffix = initkwargs.get(<span class="string">&#x27;suffix&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">        view.actions = actions</span><br><span class="line">        <span class="keyword">return</span> csrf_exempt(view)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize_request</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Set the `.action` attribute on the view,</span></span><br><span class="line"><span class="string">        depending on the request method.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        request = <span class="built_in">super</span>(ViewSetMixin, self).initialize_request(request, *args, **kwargs)</span><br><span class="line">        method = request.method.lower()</span><br><span class="line">        <span class="keyword">if</span> method == <span class="string">&#x27;options&#x27;</span>:</span><br><span class="line">            <span class="comment"># This is a special case as we always provide handling for the</span></span><br><span class="line">            <span class="comment"># options method in the base `View` class.</span></span><br><span class="line">            <span class="comment"># Unlike the other explicitly defined actions, &#x27;metadata&#x27; is implicit.</span></span><br><span class="line">            self.action = <span class="string">&#x27;metadata&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.action = self.action_map.get(method)</span><br><span class="line">        <span class="keyword">return</span> request</span><br></pre></td></tr></table></figure>


<h4 id="rest-framework-viewsets-ReadOnlyModelViewSet"><a href="#rest-framework-viewsets-ReadOnlyModelViewSet" class="headerlink" title="rest_framework.viewsets.ReadOnlyModelViewSet"></a>rest_framework.viewsets.ReadOnlyModelViewSet</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">继承两个混合类</span></span><br><span class="line"><span class="string">    - mixins.RetrieveModelMixin  提供retrieve()方法，实现详情视图</span></span><br><span class="line"><span class="string">    - mixins.ListModelMixin     提供list()方法，实现列表视图</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadOnlyModelViewSet</span>(<span class="params">mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="params"><span class="class">                           mixins.ListModelMixin,</span></span></span><br><span class="line"><span class="params"><span class="class">                           GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    A viewset that provides default `list()` and `retrieve()` actions.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h4 id="rest-framework-viewsets-ModelViewSet"><a href="#rest-framework-viewsets-ModelViewSet" class="headerlink" title="rest_framework.viewsets.ModelViewSet"></a>rest_framework.viewsets.ModelViewSet</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">继承五个混合类</span></span><br><span class="line"><span class="string">    - mixins.CreateModelMixin   提供create()方法，实现创建对象视图</span></span><br><span class="line"><span class="string">    - mixins.RetrieveModelMixin  提供retrieve()方法，实现对象详情视图</span></span><br><span class="line"><span class="string">    - mixins.ListModelMixin     提供list()方法，实现列表视图</span></span><br><span class="line"><span class="string">    - mixins.UpdateModelMixin   提供update()方法，实现更新对象视图</span></span><br><span class="line"><span class="string">    - mixins.DestroyModelMixin  提供destroy()方法，实现删除对象视图</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelViewSet</span>(<span class="params">mixins.CreateModelMixin,</span></span></span><br><span class="line"><span class="params"><span class="class">                   mixins.RetrieveModelMixin,</span></span></span><br><span class="line"><span class="params"><span class="class">                   mixins.UpdateModelMixin,</span></span></span><br><span class="line"><span class="params"><span class="class">                   mixins.DestroyModelMixin,</span></span></span><br><span class="line"><span class="params"><span class="class">                   mixins.ListModelMixin,</span></span></span><br><span class="line"><span class="params"><span class="class">                   GenericViewSet</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    A viewset that provides default `create()`, `retrieve()`, `update()`,</span></span><br><span class="line"><span class="string">    `partial_update()`, `destroy()` and `list()` actions.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Python</category>
        <category>Web</category>
      </categories>
      <tags>
        <tag>Django</tag>
        <tag>Python</tag>
        <tag>Restful</tag>
      </tags>
  </entry>
  <entry>
    <title>DRF最佳实践及源码解读(五)--解析与序列化</title>
    <url>/2020/04/19/DRF%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E4%BA%94-%E8%A7%A3%E6%9E%90%E4%B8%8E%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    <content><![CDATA[<img src="/images/djangorestframework.png" class="" title="DRF框架">

<span id="more"></span>

<h2 id="解析器：DRF提供不同的解析器对多种类型的请求参数进行封装"><a href="#解析器：DRF提供不同的解析器对多种类型的请求参数进行封装" class="headerlink" title="解析器：DRF提供不同的解析器对多种类型的请求参数进行封装"></a>解析器：DRF提供不同的解析器对多种类型的请求参数进行封装</h2><h3 id="解析器使用"><a href="#解析器使用" class="headerlink" title="解析器使用"></a>解析器使用</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">1.</span>全局配置</span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PARSER_CLASSES&#x27;</span>: [<span class="string">&#x27;rest_framework.parsers.JSONParser&#x27;</span>, <span class="string">&#x27;rest_framework.parsers.FormParser&#x27;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">2.</span>局部配置</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 局部配置</span></span><br><span class="line">    parser_classes = [FileUploadParser]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        data = request.data</span><br><span class="line">        ...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="解析器原理"><a href="#解析器原理" class="headerlink" title="解析器原理"></a>解析器原理</h3><ol>
<li>在dispatch中对request进行封装</li>
<li>request.data调用时获取配置的解析器</li>
<li>使用解析器解析请求数据并封装</li>
</ol>
<h2 id="序列化器：DRF序列化器提供数据的序列化及反序列化处理"><a href="#序列化器：DRF序列化器提供数据的序列化及反序列化处理" class="headerlink" title="序列化器：DRF序列化器提供数据的序列化及反序列化处理"></a>序列化器：DRF序列化器提供数据的序列化及反序列化处理</h2><h3 id="Serializer"><a href="#Serializer" class="headerlink" title="Serializer"></a>Serializer</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># models</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Group</span>(<span class="params">models.Model</span>):</span></span><br><span class="line"></span><br><span class="line">    group_id = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    group_name = models.CharField(max_length=<span class="number">32</span>, verbose_name=<span class="string">&#x27;组名&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span>(<span class="params">models.Model</span>):</span></span><br><span class="line"></span><br><span class="line">    GENDER_CHOICES = (</span><br><span class="line">        (<span class="number">1</span>, <span class="string">&#x27;male&#x27;</span>),</span><br><span class="line">        (<span class="number">2</span>, <span class="string">&#x27;female&#x27;</span>),</span><br><span class="line">        (<span class="number">3</span>, <span class="string">&#x27;unknown&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    username = models.CharField(max_length=<span class="number">32</span>, verbose_name=<span class="string">&#x27;用户名&#x27;</span>)</span><br><span class="line">    password = models.CharField(max_length=<span class="number">64</span>, verbose_name=<span class="string">&#x27;密码&#x27;</span>)</span><br><span class="line">    gender = models.SmallIntegerField(choices=GENDER_CHOICES, default=<span class="number">3</span>, verbose_name=<span class="string">&#x27;性别&#x27;</span>)</span><br><span class="line">    group = models.ForeignKey(Group)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># serializers</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;用户序列化器&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">id</span> = serializers.IntegerField()</span><br><span class="line">    username = serializers.CharField(max_length=<span class="number">20</span>)  <span class="comment"># max_length限定字符串最大长度</span></span><br><span class="line">    <span class="comment"># gender = serializers.IntegerField()</span></span><br><span class="line">    gender = serializers.CharField(source=<span class="string">&#x27;get_gender_display&#x27;</span>)  <span class="comment"># source指定对象的属性</span></span><br><span class="line">    <span class="comment"># group_id = serializers.IntegerField(source=&#x27;group.group_id&#x27;)  # source指定对象的属性</span></span><br><span class="line">    group = serializers.CharField(source=<span class="string">&#x27;group.group_name&#x27;</span>)  <span class="comment"># source指定关联对象的属性</span></span><br><span class="line">    desc = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_desc</span>(<span class="params">self, user</span>):</span></span><br><span class="line">        <span class="comment"># 自定义 SerializerMethodField</span></span><br><span class="line">        <span class="comment"># 实现&#x27;get_ + field&#x27;方法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;hello&#x27;</span> + user.username</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment"># views</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取用户queryset</span></span><br><span class="line">        users = User.objects.<span class="built_in">all</span>()</span><br><span class="line">        <span class="comment"># 构造序列化器</span></span><br><span class="line">        serializer = UserSerializer(instance=users, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 返回序列化数据</span></span><br><span class="line">        <span class="keyword">return</span> JsonResponse(serializer.data, safe=<span class="literal">False</span>)</span><br><span class="line">        </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ModelSerializer"><a href="#ModelSerializer" class="headerlink" title="ModelSerializer"></a>ModelSerializer</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">在对model进行序列化时可以直接使用ModelSerializer,可以自动生成序列字段</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserModelSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line"></span><br><span class="line">    group = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_group</span>(<span class="params">self, user</span>):</span></span><br><span class="line">        <span class="keyword">return</span> user.group.group_name</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = User</span><br><span class="line">        <span class="comment"># fields = &#x27;__all__&#x27;    # 自动生成所有字段</span></span><br><span class="line">        fields = [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;gender&#x27;</span>, <span class="string">&#x27;group&#x27;</span>]</span><br></pre></td></tr></table></figure>


<h3 id="自动序列化连表深度控制"><a href="#自动序列化连表深度控制" class="headerlink" title="自动序列化连表深度控制"></a>自动序列化连表深度控制</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserDepthSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = User</span><br><span class="line">        <span class="comment"># fields = &#x27;__all__&#x27;    # 自动生成所有字段</span></span><br><span class="line">        fields = [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;gender&#x27;</span>, <span class="string">&#x27;group&#x27;</span>]</span><br><span class="line">        depth = <span class="number">1</span>  <span class="comment"># 0~10</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">可以很方便的做数据验证</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserDepthSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = User</span><br><span class="line">        <span class="comment"># fields = &#x27;__all__&#x27;    # 自动生成所有字段</span></span><br><span class="line">        fields = [<span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;gender&#x27;</span>, <span class="string">&#x27;group&#x27;</span>]</span><br><span class="line">        depth = <span class="number">1</span>  <span class="comment"># 0~10</span></span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_username</span>(<span class="params">self, value</span>):</span></span><br><span class="line">        <span class="comment"># 验证单个字段</span></span><br><span class="line">        <span class="keyword">if</span> value.startswith(<span class="string">&#x27;孙&#x27;</span>):</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">&#x27;名称不合法&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        <span class="comment"># 验证多个字段</span></span><br><span class="line">        <span class="keyword">return</span> attrs</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        <span class="comment"># 新建</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self, instance, validated_data</span>):</span></span><br><span class="line">        <span class="comment"># 更新</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        serializer = UserModelSerializer(data=request.data)</span><br><span class="line">        <span class="comment"># 校验数据</span></span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># 获取校验通过的数据</span></span><br><span class="line">        data = serializer.validated_data</span><br><span class="line">        <span class="comment"># 当序列化器实例化时没有传instance,则save()方法调用create()方法，反之调用update()方法</span></span><br><span class="line">        serializer.save()</span><br><span class="line">        </span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Python</category>
        <category>Web</category>
      </categories>
      <tags>
        <tag>Django</tag>
        <tag>Python</tag>
        <tag>Restful</tag>
      </tags>
  </entry>
  <entry>
    <title>DRF最佳实践及源码解读(八)--流量控制</title>
    <url>/2020/04/19/DRF%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E5%85%AB-%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6/</url>
    <content><![CDATA[<img src="/images/djangorestframework.png" class="" title="DRF框架">

<span id="more"></span>

<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 针对认证用户和非认证用户进行限流</span></span><br><span class="line"></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: (</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.AnonRateThrottle&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.UserRateThrottle&#x27;</span></span><br><span class="line">    ),</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;anon&#x27;</span>: <span class="string">&#x27;4/day&#x27;</span>, <span class="comment"># 匿名用户每天访问4次</span></span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>: <span class="string">&#x27;100/day&#x27;</span>  <span class="comment"># 登录用户访问100次</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 针对不同视图设置不同频次</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContactListView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    throttle_scope = <span class="string">&#x27;contacts&#x27;</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ContactDetailView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    throttle_scope = <span class="string">&#x27;contacts&#x27;</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UploadView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    throttle_scope = <span class="string">&#x27;uploads&#x27;</span></span><br><span class="line">    ...</span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: (</span><br><span class="line">        <span class="string">&#x27;rest_framework.throttling.ScopedRateThrottle&#x27;</span>,</span><br><span class="line">    ),</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;contacts&#x27;</span>: <span class="string">&#x27;1000/day&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;uploads&#x27;</span>: <span class="string">&#x27;20/day&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Python</category>
        <category>Web</category>
      </categories>
      <tags>
        <tag>Django</tag>
        <tag>Python</tag>
        <tag>Restful</tag>
      </tags>
  </entry>
  <entry>
    <title>DRF最佳实践及源码解读(六)--认证</title>
    <url>/2020/04/19/DRF%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E5%85%AD-%E8%AE%A4%E8%AF%81/</url>
    <content><![CDATA[<img src="/images/djangorestframework.png" class="" title="DRF框架">

<span id="more"></span>

<h2 id="使用认证"><a href="#使用认证" class="headerlink" title="使用认证"></a>使用认证</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">1.自定义认证类，继承rest_framework.authentication.BaseAuthentication, 实现authenticate方法</span></span><br><span class="line"><span class="string">2.视图类局部配置或全局配置</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BaseAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> exceptions</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyAuthentication</span>(<span class="params">BaseAuthentication</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;自定义认证类继承BaseAuthentication&quot;&quot;&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="comment"># return None   # 不处理</span></span><br><span class="line">        <span class="comment"># raise exceptions.AuthenticationFailed()  # 认证失败抛出异常</span></span><br><span class="line">        <span class="comment"># return (a, b)  # a赋值给request.user, b赋值给request.auth</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 局部配置</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserView</span>(<span class="params">APIView</span>):</span></span><br><span class="line"></span><br><span class="line">    authentication_classes = [MyAuthentication,]</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line"></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework.authentication.BasicAuthentication&#x27;</span>,   <span class="comment"># 基本表单认证</span></span><br><span class="line">        <span class="string">&#x27;rest_framework.authentication.SessionAuthentication&#x27;</span>,  <span class="comment"># session认证</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;UNAUTHENTICATED_USER&#x27;</span>: <span class="literal">None</span>  <span class="comment"># 匿名用户 request.user</span></span><br><span class="line">    <span class="string">&#x27;UNAUTHENTICATED_TOKEN&#x27;</span>: <span class="literal">None</span>  <span class="comment"># 匿名   request.auth</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><img src="/images/drf_auth_class.png" class="" title="DRF认证">


<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_authenticate</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Attempt to authenticate the request using each authentication instance</span></span><br><span class="line"><span class="string">    in turn.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> authenticator <span class="keyword">in</span> self.authenticators:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            user_auth_tuple = authenticator.authenticate(self)</span><br><span class="line">        <span class="keyword">except</span> exceptions.APIException:</span><br><span class="line">            self._not_authenticated()</span><br><span class="line">            <span class="keyword">raise</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> user_auth_tuple <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self._authenticator = authenticator</span><br><span class="line">            self.user, self.auth = user_auth_tuple</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    self._not_authenticated()</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Python</category>
        <category>Web</category>
      </categories>
      <tags>
        <tag>Django</tag>
        <tag>Python</tag>
        <tag>Restful</tag>
      </tags>
  </entry>
  <entry>
    <title>DRF最佳实践及源码解读(四)--版本控制</title>
    <url>/2020/04/18/DRF%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E5%8F%8A%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB-%E5%9B%9B-%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/</url>
    <content><![CDATA[<img src="/images/djangorestframework.png" class="" title="DRF框架">

<span id="more"></span>

<h2 id="DRF支持queryparams、urlpath等多种方式的路由版本控制"><a href="#DRF支持queryparams、urlpath等多种方式的路由版本控制" class="headerlink" title="DRF支持queryparams、urlpath等多种方式的路由版本控制"></a>DRF支持queryparams、urlpath等多种方式的路由版本控制</h2><h3 id="1-原理"><a href="#1-原理" class="headerlink" title="1.原理"></a>1.原理</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">1.在请求分发前的初始化处理中引入版本控制</span></span><br><span class="line"><span class="string">2.通过versioning_class获取具体的版本控制类</span></span><br><span class="line"><span class="string">3.将获取到的版本version及版本控制对象versioning_scheme赋值给request</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIView</span>(<span class="params">View</span>):</span></span><br><span class="line">    versioning_class = api_settings.DEFAULT_VERSIONING_CLASS</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initial</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Runs anything that needs to occur prior to calling the method handler.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.format_kwarg = self.get_format_suffix(**kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Perform content negotiation and store the accepted info on the request</span></span><br><span class="line">        neg = self.perform_content_negotiation(request)</span><br><span class="line">        request.accepted_renderer, request.accepted_media_type = neg</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Determine the API version, if versioning is in use.</span></span><br><span class="line">        version, scheme = self.determine_version(request, *args, **kwargs)</span><br><span class="line">        request.version, request.versioning_scheme = version, scheme</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Ensure that the incoming request is permitted</span></span><br><span class="line">        self.perform_authentication(request)</span><br><span class="line">        self.check_permissions(request)</span><br><span class="line">        self.check_throttles(request)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">determine_version</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        If versioning is being used, then determine any API version for the</span></span><br><span class="line"><span class="string">        incoming request. Returns a two-tuple of (version, versioning_scheme)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.versioning_class <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> (<span class="literal">None</span>, <span class="literal">None</span>)</span><br><span class="line">        scheme = self.versioning_class()</span><br><span class="line">        <span class="keyword">return</span> (scheme.determine_version(request, *args, **kwargs), scheme)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-用法"><a href="#2-用法" class="headerlink" title="2.用法"></a>2.用法</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">最常用的是urlpath中进行版本控制</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">1.全局配置</span></span><br><span class="line"><span class="string">REST_FRAMEWORK = &#123;</span></span><br><span class="line"><span class="string">    # 版本控制类</span></span><br><span class="line"><span class="string">    &quot;DEFAULT_VERSIONING_CLASS&quot;: &quot;rest_framework.versioning.URLPathVersioning&quot;,</span></span><br><span class="line"><span class="string">    # 默认版本</span></span><br><span class="line"><span class="string">    &quot;DEFAULT_VERSION&quot;: &quot;v1&quot;,</span></span><br><span class="line"><span class="string">    # 允许的版本</span></span><br><span class="line"><span class="string">    &quot;ALLOWED_VERSIONS&quot;: [&quot;v1&quot;, &quot;v2&quot;],</span></span><br><span class="line"><span class="string">    # 版本参数名</span></span><br><span class="line"><span class="string">    &quot;VERSION_PARAM&quot;: &quot;version&quot;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2.路由系统</span></span><br><span class="line"><span class="string">urlpatterns = [</span></span><br><span class="line"><span class="string">    url(r&#x27;^(?P&lt;version&gt;[v1|v2]+)/users/$&#x27;, views.UserView.as_view(), name=&#x27;user&#x27;),</span></span><br><span class="line"><span class="string">]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3.视图使用</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">class UserView(APIView):</span></span><br><span class="line"><span class="string">    def get(self, request, *args, **kwargs):</span></span><br><span class="line"><span class="string">        # 获取版本</span></span><br><span class="line"><span class="string">        version = request.version</span></span><br><span class="line"><span class="string">        # 获取版本控制对象</span></span><br><span class="line"><span class="string">        version_schema = request.versioning_schema</span></span><br><span class="line"><span class="string">        # 反向生成url</span></span><br><span class="line"><span class="string">        u1 = request.versioning_schema.reverse(viewname=&#x27;user&#x27;, request=request)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">URLPathVersioning</span>(<span class="params">BaseVersioning</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    To the client this is the same style as `NamespaceVersioning`.</span></span><br><span class="line"><span class="string">    The difference is in the backend - this implementation uses</span></span><br><span class="line"><span class="string">    Django&#x27;s URL keyword arguments to determine the version.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    An example URL conf for two views that accept two different versions.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    urlpatterns = [</span></span><br><span class="line"><span class="string">        url(r&#x27;^(?P&lt;version&gt;[v1|v2]+)/users/$&#x27;, users_list, name=&#x27;users-list&#x27;),</span></span><br><span class="line"><span class="string">        url(r&#x27;^(?P&lt;version&gt;[v1|v2]+)/users/(?P&lt;pk&gt;[0-9]+)/$&#x27;, users_detail, name=&#x27;users-detail&#x27;)</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    GET /1.0/something/ HTTP/1.1</span></span><br><span class="line"><span class="string">    Host: example.com</span></span><br><span class="line"><span class="string">    Accept: application/json</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    default_version = api_settings.DEFAULT_VERSION</span><br><span class="line">    allowed_versions = api_settings.ALLOWED_VERSIONS</span><br><span class="line">    version_param = api_settings.VERSION_PARAM</span><br><span class="line">    invalid_version_message = _(<span class="string">&#x27;Invalid version in URL path.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">determine_version</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        version = kwargs.get(self.version_param, self.default_version)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.is_allowed_version(version):</span><br><span class="line">            <span class="keyword">raise</span> exceptions.NotFound(self.invalid_version_message)</span><br><span class="line">        <span class="keyword">return</span> version</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reverse</span>(<span class="params">self, viewname, args=<span class="literal">None</span>, kwargs=<span class="literal">None</span>, request=<span class="literal">None</span>, <span class="built_in">format</span>=<span class="literal">None</span>, **extra</span>):</span></span><br><span class="line">        <span class="keyword">if</span> request.version <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            kwargs = &#123;&#125; <span class="keyword">if</span> (kwargs <span class="keyword">is</span> <span class="literal">None</span>) <span class="keyword">else</span> kwargs</span><br><span class="line">            kwargs[self.version_param] = request.version</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>(URLPathVersioning, self).reverse(</span><br><span class="line">            viewname, args, kwargs, request, <span class="built_in">format</span>, **extra</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Python</category>
        <category>Web</category>
      </categories>
      <tags>
        <tag>Django</tag>
        <tag>Python</tag>
        <tag>Restful</tag>
      </tags>
  </entry>
</search>
