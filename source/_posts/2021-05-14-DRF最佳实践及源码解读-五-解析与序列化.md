---
title: DRF最佳实践及源码解读(五)--解析与序列化
date: 2020-04-19 14:46:37
categories:
- [Python, Web]
tags:
    - Django
    - Python
    - Restful
---

{% img /images/djangorestframework.png    '"DRF框架"' %}

<!-- more -->

## 解析器：DRF提供不同的解析器对多种类型的请求参数进行封装

### 解析器使用

{% codeblock lang:python %}

1.全局配置
REST_FRAMEWORK = {
    'DEFAULT_PARSER_CLASSES': ['rest_framework.parsers.JSONParser', 'rest_framework.parsers.FormParser']
}

2.局部配置

class ParserView(APIView):
    # 局部配置
    parser_classes = [FileUploadParser]
    
    def post(self, request, *args, **kwargs):
        data = request.data
        ...

{% endcodeblock %}

### 解析器原理

1. 在dispatch中对request进行封装
2. request.data调用时获取配置的解析器
3. 使用解析器解析请求数据并封装


## 序列化器：DRF序列化器提供数据的序列化及反序列化处理

### Serializer

{% codeblock lang:python %}
# models

class Group(models.Model):

    group_id = models.AutoField(primary_key=True)
    group_name = models.CharField(max_length=32, verbose_name='组名')


class User(models.Model):

    GENDER_CHOICES = (
        (1, 'male'),
        (2, 'female'),
        (3, 'unknown')
    )

    username = models.CharField(max_length=32, verbose_name='用户名')
    password = models.CharField(max_length=64, verbose_name='密码')
    gender = models.SmallIntegerField(choices=GENDER_CHOICES, default=3, verbose_name='性别')
    group = models.ForeignKey(Group)


# serializers

from rest_framework import serializers


class UserSerializer(serializers.Serializer):
    """用户序列化器"""

    id = serializers.IntegerField()
    username = serializers.CharField(max_length=20)  # max_length限定字符串最大长度
    # gender = serializers.IntegerField()
    gender = serializers.CharField(source='get_gender_display')  # source指定对象的属性
    # group_id = serializers.IntegerField(source='group.group_id')  # source指定对象的属性
    group = serializers.CharField(source='group.group_name')  # source指定关联对象的属性
    desc = serializers.SerializerMethodField()

    def get_desc(self, user):
        # 自定义 SerializerMethodField
        # 实现'get_ + field'方法
        return 'hello' + user.username
    

# views

class UserView(APIView):

    def get(self, request, *args, **kwargs):

        # 获取用户queryset
        users = User.objects.all()
        # 构造序列化器
        serializer = UserSerializer(instance=users, many=True)
        # 返回序列化数据
        return JsonResponse(serializer.data, safe=False)
        

{% endcodeblock %}

### ModelSerializer

{% codeblock lang:python %}
"""
在对model进行序列化时可以直接使用ModelSerializer,可以自动生成序列字段
"""

class UserModelSerializer(serializers.ModelSerializer):

    group = serializers.SerializerMethodField()

    def get_group(self, user):
        return user.group.group_name

    class Meta:
        model = User
        # fields = '__all__'    # 自动生成所有字段
        fields = ['id', 'username', 'gender', 'group']
{% endcodeblock %}


### 自动序列化连表深度控制

{% codeblock lang:python %}
class UserDepthSerializer(serializers.ModelSerializer):

    class Meta:
        model = User
        # fields = '__all__'    # 自动生成所有字段
        fields = ['id', 'username', 'gender', 'group']
        depth = 1  # 0~10

{% endcodeblock %}

### 反序列化

{% codeblock lang:python %}

"""
可以很方便的做数据验证
"""

class UserDepthSerializer(serializers.ModelSerializer):

    class Meta:
        model = User
        # fields = '__all__'    # 自动生成所有字段
        fields = ['id', 'username', 'gender', 'group']
        depth = 1  # 0~10
        
    def validate_username(self, value):
        # 验证单个字段
        if value.startswith('孙'):
            raise serializers.ValidationError('名称不合法')
        return value
    
    def validate(self, attrs):
        # 验证多个字段
        return attrs
    
    def create(self, validated_data):
        # 新建
        pass
    
    def update(self, instance, validated_data):
        # 更新
        pass
        

class UserView(APIView):

    def post(self, request, *args, **kwargs):
        serializer = UserModelSerializer(data=request.data)
        # 校验数据
        serializer.is_valid(raise_exception=True)
        # 获取校验通过的数据
        data = serializer.validated_data
        # 当序列化器实例化时没有传instance,则save()方法调用create()方法，反之调用update()方法
        serializer.save()
        

{% endcodeblock %}