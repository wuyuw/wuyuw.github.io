---
title: DRF最佳实践及源码解读(六)--认证
date: 2020-04-19 15:02:37
categories:
- [Python, Web]
tags:
    - Django
    - Python
    - Restful
---

{% img /images/djangorestframework.png    '"DRF框架"' %}

<!-- more -->

## 使用认证

{% codeblock lang:python %}
"""
1.自定义认证类，继承rest_framework.authentication.BaseAuthentication, 实现authenticate方法
2.视图类局部配置或全局配置
"""
from rest_framework.authentication import BaseAuthentication
from rest_framework import exceptions

class MyAuthentication(BaseAuthentication):
    """自定义认证类继承BaseAuthentication"""
    def authenticate(self, request):
        # return None   # 不处理
        # raise exceptions.AuthenticationFailed()  # 认证失败抛出异常
        # return (a, b)  # a赋值给request.user, b赋值给request.auth
        pass

# 局部配置

class UserView(APIView):

    authentication_classes = [MyAuthentication,]
    
# 全局配置

REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework.authentication.BasicAuthentication',   # 基本表单认证
        'rest_framework.authentication.SessionAuthentication',  # session认证
    ],
    'UNAUTHENTICATED_USER': None  # 匿名用户 request.user
    'UNAUTHENTICATED_TOKEN': None  # 匿名   request.auth
}

{% endcodeblock %}

## 原理

{% img /images/drf_auth_class.png    '"DRF认证"' %}


{% codeblock lang:python %}
    def _authenticate(self):
        """
        Attempt to authenticate the request using each authentication instance
        in turn.
        """
        for authenticator in self.authenticators:
            try:
                user_auth_tuple = authenticator.authenticate(self)
            except exceptions.APIException:
                self._not_authenticated()
                raise

            if user_auth_tuple is not None:
                self._authenticator = authenticator
                self.user, self.auth = user_auth_tuple
                return

        self._not_authenticated()
{% endcodeblock %}

